#!/usr/bin/env sh
# Copy /opt/NetVest to a writable location (default: $HOME/NetVest).
# Idempotent: skips if DEST already exists, unless --force is given.

set -eu

usage() {
  cat <<'EOF'
Usage: netvest-init [--src PATH] [--dest PATH] [--force]

Options:
  --src  PATH   Source folder (default: $NETVEST_SRC or /opt/NetVest)
  --dest PATH   Destination folder (default: $NETVEST_DEST or $HOME/NetVest)
  --force       Overwrite DEST if it exists
  -h, --help    Show this help

Examples:
  netvest-init
  netvest-init --dest /work/NetVest
  NETVEST_SRC=/opt/NetVest NETVEST_DEST=$HOME/NetVest netvest-init --force
EOF
}

SRC="${NETVEST_SRC:-/opt/NetVest}"
DEST="${NETVEST_DEST:-$HOME/NetVest}"
FORCE=0

# Parse args
while [ $# -gt 0 ]; do
  case "$1" in
    --src)  SRC="$2"; shift 2 ;;
    --dest) DEST="$2"; shift 2 ;;
    --force) FORCE=1; shift ;;
    -h|--help) usage; exit 0 ;;
    *) DEST="$1"; shift ;;
  esac
done

# Checks
[ -d "$SRC" ] || { echo "netvest-init: source not found: $SRC" >&2; exit 2; }

if [ -e "$DEST" ] && [ "$FORCE" -ne 1 ]; then
  echo "netvest-init: $DEST exists; skipping (use --force to overwrite)"; exit 0
fi

[ "$FORCE" -eq 1 ] && [ -e "$DEST" ] && rm -rf "$DEST" || true
mkdir -p "$DEST"

# Copy (prefer rsync; fallback to cp -rL)
if command -v rsync >/dev/null 2>&1; then
  rsync -aL --no-owner --no-group "$SRC"/ "$DEST"/
else
  cp -rL "$SRC"/. "$DEST"/
fi

echo "netvest-init: copied $SRC â†’ $DEST"
